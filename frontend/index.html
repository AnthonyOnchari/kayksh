<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KayKSH - Play Trivia & Win Money</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #004E89;
            --success: #00B894;
            --danger: #E63946;
            --warning: #FF9F1C;
            --dark: #1A1A2E;
            --light: #F8F9FA;
            --kenya-green: #006400;
            --kenya-red: #BB0000;
            --kenya-black: #000000;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #000428 0%, #004e92 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.8rem;
            background: linear-gradient(45deg, var(--kenya-green), var(--kenya-red), var(--kenya-black));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .logo-text {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--kenya-green), var(--kenya-red), var(--kenya-black));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .points-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .points-badge {
            background: linear-gradient(45deg, var(--kenya-green), var(--kenya-red));
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.3rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Warning Message */
        .warning-box {
            background: linear-gradient(45deg, #FF9F1C, #FF6B35);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(255, 159, 28, 0.3);
        }
        
        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }
        
        /* Game Card */
        .game-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .game-card h2 {
            color: var(--dark);
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .game-card p {
            color: #666;
            margin-bottom: 25px;
        }
        
        /* Question Box */
        .question-box {
            background: linear-gradient(135deg, var(--secondary), #001f3f);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
        }
        
        .question-text {
            font-size: 1.3rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .question-meta {
            display: flex;
            justify-content: space-between;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        
        /* Options */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 25px 0;
        }
        
        .option-btn {
            padding: 20px;
            background: white;
            border: 3px solid #E5E7EB;
            border-radius: 12px;
            text-align: left;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .option-btn:hover {
            border-color: var(--primary);
            transform: translateX(10px);
        }
        
        .option-btn.selected {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.1);
        }
        
        .option-btn.correct {
            border-color: var(--success);
            background: rgba(0, 184, 148, 0.1);
        }
        
        .option-btn.wrong {
            border-color: var(--danger);
            background: rgba(230, 57, 70, 0.1);
        }
        
        .option-letter {
            width: 40px;
            height: 40px;
            background: #F3F4F6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--dark);
        }
        
        .option-btn.selected .option-letter {
            background: var(--primary);
            color: white;
        }
        
        /* Game Controls */
        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 18px 35px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 107, 53, 0.4);
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid #E5E7EB;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Timer */
        .timer {
            text-align: center;
            margin: 25px 0;
        }
        
        .timer-circle {
            width: 100px;
            height: 100px;
            border: 5px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            background: white;
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.3);
        }
        
        /* Payment Sidebar */
        .payment-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: sticky;
            top: 30px;
        }
        
        .payment-card h3 {
            color: var(--dark);
            font-size: 1.5rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Payment Amounts */
        .amount-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .amount-option {
            padding: 20px 15px;
            border: 3px solid #E5E7EB;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .amount-option:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }
        
        .amount-option.selected {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.1);
        }
        
        .amount-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .amount-points {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Phone Input */
        .phone-input {
            margin: 25px 0;
        }
        
        .phone-input label {
            display: block;
            color: var(--dark);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .phone-input input {
            width: 100%;
            padding: 18px;
            border: 3px solid #E5E7EB;
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: 'Inter', sans-serif;
        }
        
        .phone-input input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Pay Button */
        .pay-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(45deg, var(--kenya-green), var(--kenya-red));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .pay-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 100, 0, 0.4);
        }
        
        .pay-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Payment Status */
        .payment-status {
            margin-top: 25px;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            display: none;
        }
        
        .payment-status.success {
            background: rgba(0, 184, 148, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
            display: block;
        }
        
        .payment-status.error {
            background: rgba(230, 57, 70, 0.1);
            border: 2px solid var(--danger);
            color: var(--danger);
            display: block;
        }
        
        /* Game Rules */
        .rules {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #E5E7EB;
        }
        
        .rules h4 {
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rules ul {
            list-style: none;
            color: #666;
        }
        
        .rules li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }
        
        .rules li:before {
            content: "â€¢";
            color: var(--primary);
            font-size: 1.5rem;
            position: absolute;
            left: 0;
        }
        
        /* Result Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .modal-icon {
            font-size: 5rem;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 2rem;
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        .modal-message {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .payment-card {
                position: static;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .logo-text {
                font-size: 2rem;
            }
            
            .game-controls {
                flex-direction: column;
            }
            
            .amount-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-coins"></i>
                <div>
                    <div class="logo-text">KayKSH</div>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">Play Trivia. Win Real Money.</p>
                </div>
            </div>
            <div class="points-container">
                <div class="points-badge">
                    <i class="fas fa-wallet"></i>
                    <span id="userPoints">0</span> Points
                </div>
            </div>
        </div>
        
        <!-- Warning -->
        <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            You need points to play! Deposit via M-Pesa first.
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Game Section -->
            <div class="game-card">
                <h2><i class="fas fa-gamepad"></i> Trivia Challenge</h2>
                <p style="color: #666;">Answer correctly to win points. Convert points to real money!</p>
                
                <!-- Stats -->
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="gamesPlayed">0</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="gamesWon">0</div>
                        <div class="stat-label">Games Won</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="winRate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalWon">0</div>
                        <div class="stat-label">Points Won</div>
                    </div>
                </div>
                
                <!-- Timer -->
                <div class="timer">
                    <div class="timer-circle">
                        <span id="countdown">30</span>
                    </div>
                    <p>Seconds remaining</p>
                </div>
                
                <!-- Question -->
                <div class="question-box">
                    <div class="question-text" id="questionText">
                        Deposit points first to play! Click "Buy Points" on the right.
                    </div>
                    <div class="question-meta">
                        <span id="questionCategory">--</span>
                        <span id="questionDifficulty">--</span>
                    </div>
                </div>
                
                <!-- Options -->
                <div class="options-grid" id="optionsContainer">
                    <!-- Options will be loaded here -->
                </div>
                
                <!-- Game Controls -->
                <div class="game-controls">
                    <button id="playBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-lock"></i>
                        Need Points to Play
                    </button>
                    <button id="submitBtn" class="btn btn-secondary" disabled>
                        <i class="fas fa-paper-plane"></i>
                        Submit Answer
                    </button>
                </div>
                
                <!-- Game Info -->
                <div style="text-align: center; margin-top: 25px; color: #666;">
                    <p><i class="fas fa-info-circle"></i> Entry: 100 Points | Prize: 500 Points</p>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div class="payment-card">
                <h3><i class="fas fa-shopping-cart"></i> Buy Points</h3>
                <p style="color: #666; margin-bottom: 25px;">Deposit via M-Pesa STK Push to get points</p>
                
                <!-- Amount Selection -->
                <div class="amount-options">
                    <div class="amount-option" data-amount="50" data-points="500">
                        <div class="amount-price">KSh 50</div>
                        <div class="amount-points">500 Points</div>
                    </div>
                    <div class="amount-option selected" data-amount="100" data-points="1200">
                        <div class="amount-price">KSh 100</div>
                        <div class="amount-points">1,200 Points</div>
                    </div>
                    <div class="amount-option" data-amount="200" data-points="2500">
                        <div class="amount-price">KSh 200</div>
                        <div class="amount-points">2,500 Points</div>
                    </div>
                    <div class="amount-option" data-amount="500" data-points="7000">
                        <div class="amount-price">KSh 500</div>
                        <div class="amount-points">7,000 Points</div>
                    </div>
                </div>
                
                <!-- Phone Input -->
                <div class="phone-input">
                    <label for="phoneNumber">
                        <i class="fas fa-mobile-alt"></i> M-Pesa Phone Number
                    </label>
                    <input type="tel" id="phoneNumber" placeholder="07XXXXXXXXX" maxlength="10">
                    <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                        Enter your M-Pesa registered number
                    </p>
                </div>
                
                <!-- Pay Button -->
                <button id="payBtn" class="pay-btn">
                    <i class="fas fa-paper-plane"></i>
                    Pay via M-Pesa STK
                </button>
                
                <!-- Payment Status -->
                <div id="paymentStatus" class="payment-status"></div>
                
                <!-- Rules -->
                <div class="rules">
                    <h4><i class="fas fa-info-circle"></i> How It Works</h4>
                    <ul>
                        <li>Deposit points using M-Pesa</li>
                        <li>1 Point = 1 KSh value</li>
                        <li>Play trivia games (100 points per game)</li>
                        <li>Win 500 points for correct answers</li>
                        <li>Cash out anytime via M-Pesa</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Result Modal -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-icon" id="resultIcon">
                <i class="fas fa-trophy" style="color: #FF9F1C;"></i>
            </div>
            <h2 class="modal-title" id="resultTitle">You Need Points!</h2>
            <p class="modal-message" id="resultMessage">
                Deposit points first to play the trivia game.
            </p>
            <button id="closeModal" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-check"></i> OK
            </button>
        </div>
    </div>

    <!-- Real Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-mobile-alt" style="color: var(--primary);"></i>
            </div>
            <h2 class="modal-title">Payment in Progress</h2>
            <p class="modal-message">
                <strong id="processingAmount">KSh 100</strong> STK Push sent to <br>
                <strong id="processingPhone">07XXXXXXXXX</strong><br><br>
                Check your phone and enter your M-Pesa PIN to complete payment.
            </p>
            <div style="margin: 30px 0;">
                <div style="display: flex; justify-content: center; gap: 20px;">
                    <div style="text-align: center;">
                        <div style="width: 60px; height: 60px; background: #E5E7EB; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <small>Request Sent</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 60px; height: 60px; background: #E5E7EB; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <small>Enter PIN</small>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 60px; height: 60px; background: #E5E7EB; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <small>Complete</small>
                    </div>
                </div>
            </div>
            <div id="paymentTimer" style="font-size: 2rem; font-weight: 800; color: var(--primary); margin: 20px 0;">
                60
            </div>
            <p style="color: #666; margin-bottom: 25px;">
                Payment expires in <span id="timerSeconds">60</span> seconds
            </p>
            <button id="cancelPayment" class="btn btn-secondary" style="margin-right: 10px;">
                Cancel Payment
            </button>
            <button id="checkPayment" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Check Status
            </button>
        </div>
    </div>

    <script>
        // ==============================================
        // GAME STATE & CONFIGURATION
        // ==============================================
        let gameState = {
            points: 0,  // Start with ZERO points
            isPlaying: false,
            currentQuestion: null,
            selectedAnswer: null,
            timer: 30,
            timerInterval: null,
            selectedAmount: 100,
            selectedPoints: 1200,
            phoneNumber: "",
            gamesPlayed: 0,
            gamesWon: 0,
            paymentInProgress: false,
            paymentTimeout: null
        };

        // REAL PayHero API Configuration
        const PAYHERO_CONFIG = {
            // Your PayHero STK Push API endpoint
            apiUrl: 'https://short.payhero.co.ke/s/34UsaC2LVdvkDjk5xz2tri',
            
            // For testing: Use this demo endpoint that simulates real payments
            // In production, use your actual PayHero API
            demoMode: true, // Set to false when using real API
            
            // Demo responses (simulate real M-Pesa)
            demoResponses: {
                success: {
                    success: true,
                    message: "M-Pesa STK Push sent successfully",
                    transactionId: "MPE" + Date.now(),
                    amount: 100
                },
                failed: {
                    success: false,
                    message: "Payment failed. Insufficient funds or user cancelled"
                }
            }
        };

        // Trivia Questions Database
        const triviaQuestions = [
            {
                question: "What is the capital city of Kenya?",
                category: "Geography",
                difficulty: "Easy",
                correct_answer: "Nairobi",
                incorrect_answers: ["Mombasa", "Kisumu", "Nakuru"]
            },
            {
                question: "Which Kenyan athlete holds the marathon world record?",
                category: "Sports",
                difficulty: "Medium",
                correct_answer: "Eliud Kipchoge",
                incorrect_answers: ["David Rudisha", "Kipchoge Keino", "Wilson Kipsang"]
            },
            {
                question: "What is the currency of Kenya?",
                category: "Economics",
                difficulty: "Easy",
                correct_answer: "Kenyan Shilling",
                incorrect_answers: ["Kenyan Pound", "East African Shilling", "Kenyan Dollar"]
            },
            {
                question: "Which lake is the largest in Africa?",
                category: "Geography",
                difficulty: "Medium",
                correct_answer: "Lake Victoria",
                incorrect_answers: ["Lake Tanganyika", "Lake Malawi", "Lake Turkana"]
            },
            {
                question: "Who was the first president of Kenya?",
                category: "History",
                difficulty: "Medium",
                correct_answer: "Jomo Kenyatta",
                incorrect_answers: ["Daniel Moi", "Mwai Kibaki", "Uhuru Kenyatta"]
            },
            {
                question: "What year did Kenya gain independence?",
                category: "History",
                difficulty: "Easy",
                correct_answer: "1963",
                incorrect_answers: ["1960", "1965", "1970"]
            },
            {
                question: "Which ocean borders Kenya to the east?",
                category: "Geography",
                difficulty: "Easy",
                correct_answer: "Indian Ocean",
                incorrect_answers: ["Atlantic Ocean", "Pacific Ocean", "Arctic Ocean"]
            },
            {
                question: "What is the official language of Kenya?",
                category: "Language",
                difficulty: "Easy",
                correct_answer: "Swahili and English",
                incorrect_answers: ["Swahili only", "English only", "Kikuyu"]
            },
            {
                question: "Which Kenyan won the Nobel Peace Prize in 2004?",
                category: "Achievements",
                difficulty: "Hard",
                correct_answer: "Wangari Maathai",
                incorrect_answers: ["Barack Obama Sr.", "Jomo Kenyatta", "Dedan Kimathi"]
            },
            {
                question: "What is the highest mountain in Kenya?",
                category: "Geography",
                difficulty: "Medium",
                correct_answer: "Mount Kenya",
                incorrect_answers: ["Mount Kilimanjaro", "Mount Elgon", "Mount Longonot"]
            }
        ];

        // ==============================================
        // INITIALIZATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            setupEventListeners();
            updateUI();
        });

        function initializeGame() {
            // Start with 0 points - User MUST deposit first
            gameState.points = 0;
            updatePointsDisplay();
            
            // Disable play button until points are added
            updatePlayButton();
            
            // Setup amount selection
            setupAmountSelection();
        }

        function setupEventListeners() {
            // Play button
            document.getElementById('playBtn').addEventListener('click', startGame);
            
            // Submit button
            document.getElementById('submitBtn').addEventListener('click', submitAnswer);
            
            // Pay button
            document.getElementById('payBtn').addEventListener('click', initiatePayment);
            
            // Phone number input
            document.getElementById('phoneNumber').addEventListener('input', validatePhoneNumber);
            
            // Modal buttons
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelPayment').addEventListener('click', cancelPayment);
            document.getElementById('checkPayment').addEventListener('click', checkPaymentStatus);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function setupAmountSelection() {
            const amountOptions = document.querySelectorAll('.amount-option');
            amountOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selection from all options
                    amountOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Select clicked option
                    this.classList.add('selected');
                    
                    // Update game state
                    gameState.selectedAmount = parseInt(this.dataset.amount);
                    gameState.selectedPoints = parseInt(this.dataset.points);
                    
                    console.log(`Selected: KSh ${gameState.selectedAmount} for ${gameState.selectedPoints} points`);
                });
            });
        }

        // ==============================================
        // PAYMENT SYSTEM - REAL M-PESA STK PUSH
        // ==============================================
        function validatePhoneNumber() {
            const phoneInput = document.getElementById('phoneNumber');
            let phone = phoneInput.value.replace(/\D/g, '');
            
            // Format as 07XXXXXXXXX
            if (phone.startsWith('0') && phone.length <= 10) {
                phoneInput.value = phone;
            } else if (phone.startsWith('254') && phone.length === 12) {
                // Convert 254 to 0
                phone = '0' + phone.substring(3);
                phoneInput.value = phone;
            } else if (phone.startsWith('7') && phone.length === 9) {
                phone = '0' + phone;
                phoneInput.value = phone;
            }
            
            gameState.phoneNumber = phoneInput.value;
        }

        async function initiatePayment() {
            // Validate phone number
            if (!gameState.phoneNumber.match(/^07[0-9]{8}$/)) {
                showPaymentStatus('error', 'Please enter a valid M-Pesa number (07XXXXXXXXX)');
                document.getElementById('phoneNumber').focus();
                return;
            }
            
            if (gameState.paymentInProgress) {
                showPaymentStatus('error', 'A payment is already in progress');
                return;
            }
            
            // Show payment modal
            showPaymentModal();
            
            // Start payment process
            await processSTKPush();
        }

        async function processSTKPush() {
            const payBtn = document.getElementById('payBtn');
            payBtn.disabled = true;
            payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            try {
                // ==============================================
                // REAL PAYMENT INTEGRATION
                // ==============================================
                if (PAYHERO_CONFIG.demoMode) {
                    // DEMO MODE - Simulate payment
                    console.log('Demo: Sending STK Push to', gameState.phoneNumber);
                    console.log('Amount: KSh', gameState.selectedAmount);
                    
                    // Simulate API delay
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Simulate successful payment 80% of the time
                    const isSuccess = Math.random() > 0.2;
                    
                    if (isSuccess) {
                        // Simulate successful payment
                        handleSuccessfulPayment();
                    } else {
                        // Simulate failed payment
                        throw new Error('Payment failed. User cancelled or insufficient funds.');
                    }
                    
                } else {
                    // ==============================================
                    // REAL PAYHERO API CALL - UNCOMMENT AND CONFIGURE
                    // ==============================================
                    /*
                    const response = await fetch(PAYHERO_CONFIG.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer YOUR_API_KEY_HERE'
                        },
                        body: JSON.stringify({
                            amount: gameState.selectedAmount,
                            phone: gameState.phoneNumber,
                            reference: 'KayKSH_' + Date.now(),
                            callback_url: 'YOUR_WEBHOOK_URL'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        handleSuccessfulPayment(data.transactionId);
                    } else {
                        throw new Error(data.message || 'Payment failed');
                    }
                    */
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                showPaymentStatus('error', error.message || 'Payment failed. Please try again.');
                hidePaymentModal();
            } finally {
                payBtn.disabled = false;
                payBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Pay via M-Pesa STK';
            }
        }

        function handleSuccessfulPayment(transactionId = null) {
            // Add points to user account
            gameState.points += gameState.selectedPoints;
            
            // Update UI
            updatePointsDisplay();
            updatePlayButton();
            
            // Show success message
            showPaymentStatus('success', 
                `${gameState.selectedPoints} points added to your account! ` +
                `Transaction ID: ${transactionId || 'DEMO_' + Date.now()}`
            );
            
            // Update payment modal
            updatePaymentModal('success');
            
            // Log transaction
            console.log(`Payment successful: +${gameState.selectedPoints} points`);
            
            // Enable game after 3 seconds
            setTimeout(() => {
                hidePaymentModal();
                showResultModal('success', 
                    'Payment Successful!', 
                    `You now have ${gameState.points} points. You can now play the trivia game!`
                );
            }, 3000);
        }

        function showPaymentModal() {
            document.getElementById('processingAmount').textContent = 
                `KSh ${gameState.selectedAmount}`;
            document.getElementById('processingPhone').textContent = 
                gameState.phoneNumber;
            
            const modal = document.getElementById('paymentModal');
            modal.style.display = 'flex';
            
            // Start payment timer (60 seconds)
            startPaymentTimer();
        }

        function hidePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.style.display = 'none';
            
            // Clear timer
            if (gameState.paymentTimeout) {
                clearTimeout(gameState.paymentTimeout);
            }
        }

        function startPaymentTimer() {
            let seconds = 60;
            const timerElement = document.getElementById('paymentTimer');
            const secondsElement = document.getElementById('timerSeconds');
            
            gameState.paymentInProgress = true;
            
            const timer = setInterval(() => {
                seconds--;
                timerElement.textContent = seconds;
                secondsElement.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(timer);
                    paymentTimeout();
                }
            }, 1000);
            
            // Set overall timeout
            gameState.paymentTimeout = setTimeout(() => {
                clearInterval(timer);
                paymentTimeout();
            }, 60000);
        }

        function paymentTimeout() {
            gameState.paymentInProgress = false;
            showPaymentStatus('error', 'Payment timeout. Please try again.');
            hidePaymentModal();
        }

        function cancelPayment() {
            if (gameState.paymentTimeout) {
                clearTimeout(gameState.paymentTimeout);
            }
            gameState.paymentInProgress = false;
            hidePaymentModal();
            showPaymentStatus('info', 'Payment cancelled');
        }

        function checkPaymentStatus() {
            // In real implementation, check with your backend
            showPaymentStatus('info', 'Checking payment status...');
            
            // Simulate status check
            setTimeout(() => {
                if (Math.random() > 0.5) {
                    handleSuccessfulPayment();
                } else {
                    showPaymentStatus('info', 'Payment still pending. Check your phone.');
                }
            }, 1000);
        }

        function updatePaymentModal(status) {
            const steps = document.querySelectorAll('#paymentModal .modal-content > div > div > div');
            if (status === 'success') {
                steps[2].style.background = 'var(--success)';
                steps[2].style.color = 'white';
            }
        }

        function showPaymentStatus(type, message) {
            const statusElement = document.getElementById('paymentStatus');
            statusElement.className = `payment-status ${type}`;
            statusElement.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
            `;
            statusElement.style.display = 'block';
            
            // Auto hide after 5 seconds
            if (type !== 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }

        // ==============================================
        // GAME LOGIC
        // ==============================================
        function updatePlayButton() {
            const playBtn = document.getElementById('playBtn');
            
            if (gameState.points < 100) {
                playBtn.disabled = true;
                playBtn.innerHTML = '<i class="fas fa-lock"></i> Need Points to Play';
                playBtn.style.opacity = '0.7';
            } else {
                playBtn.disabled = false;
                playBtn.innerHTML = '<i class="fas fa-play"></i> Play Game (100 Points)';
                playBtn.style.opacity = '1';
            }
        }

        function loadRandomQuestion() {
            const randomIndex = Math.floor(Math.random() * triviaQuestions.length);
            gameState.currentQuestion = triviaQuestions[randomIndex];
            
            // Update question display
            document.getElementById('questionText').textContent = gameState.currentQuestion.question;
            document.getElementById('questionCategory').textContent = gameState.currentQuestion.category;
            document.getElementById('questionDifficulty').textContent = gameState.currentQuestion.difficulty;
            
            // Clear options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            // Combine answers and shuffle
            const allAnswers = [...gameState.currentQuestion.incorrect_answers, 
                                gameState.currentQuestion.correct_answer];
            shuffleArray(allAnswers);
            
            // Create option buttons
            const letters = ['A', 'B', 'C', 'D'];
            allAnswers.forEach((answer, index) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn';
                optionBtn.innerHTML = `
                    <span class="option-letter">${letters[index]}</span>
                    ${answer}
                `;
                optionBtn.dataset.answer = answer;
                
                optionBtn.addEventListener('click', function() {
                    if (!gameState.isPlaying) return;
                    
                    // Deselect all options
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    // Select this option
                    this.classList.add('selected');
                    gameState.selectedAnswer = answer;
                    document.getElementById('submitBtn').disabled = false;
                });
                
                optionsContainer.appendChild(optionBtn);
            });
        }

        function startGame() {
            // Check if user has enough points
            if (gameState.points < 100) {
                showResultModal('error', 'Not Enough Points', 
                    'You need at least 100 points to play. Deposit first.');
                return;
            }
            
            if (gameState.isPlaying) return;
            
            // Deduct entry fee
            gameState.points -= 100;
            updatePointsDisplay();
            updatePlayButton();
            
            // Start game
            gameState.isPlaying = true;
            gameState.selectedAnswer = null;
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('playBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Game Active';
            
            // Reset timer
            gameState.timer = 30;
            document.getElementById('countdown').textContent = gameState.timer;
            
            // Start timer
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                document.getElementById('countdown').textContent = gameState.timer;
                
                if (gameState.timer <= 0) {
                    clearInterval(gameState.timerInterval);
                    handleTimeUp();
                }
            }, 1000);
            
            // Load question
            loadRandomQuestion();
        }

        function submitAnswer() {
            if (!gameState.selectedAnswer || !gameState.currentQuestion) return;
            
            clearInterval(gameState.timerInterval);
            
            const isCorrect = gameState.selectedAnswer === gameState.currentQuestion.correct_answer;
            
            // Show correct/incorrect styling
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.answer === gameState.currentQuestion.correct_answer) {
                    btn.classList.add('correct');
                } else if (btn.classList.contains('selected') && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });
            
            // Update stats
            gameState.gamesPlayed++;
            
            if (isCorrect) {
                // Win prize
                const prize = 500;
                gameState.points += prize;
                gameState.gamesWon++;
                
                updatePointsDisplay();
                updatePlayButton();
                updateStats();
                
                showResultModal('success', 'Correct Answer!', 
                    `You won ${prize} points! You now have ${gameState.points} points.`);
            } else {
                updateStats();
                showResultModal('error', 'Wrong Answer', 
                    `Correct answer: ${gameState.currentQuestion.correct_answer}. ` +
                    `You lost 100 points. You have ${gameState.points} points remaining.`);
            }
            
            // Reset game after delay
            setTimeout(resetGame, 3000);
        }

        function handleTimeUp() {
            gameState.gamesPlayed++;
            updateStats();
            
            showResultModal('error', 'Time\'s Up!', 
                `You ran out of time. You lost 100 points. ` +
                `You have ${gameState.points} points remaining.`);
            
            setTimeout(resetGame, 3000);
        }

        function resetGame() {
            gameState.isPlaying = false;
            gameState.selectedAnswer = null;
            
            document.getElementById('submitBtn').disabled = true;
            updatePlayButton();
            
            // If user still has points, load new question
            if (gameState.points >= 100) {
                loadRandomQuestion();
            } else {
                document.getElementById('questionText').textContent = 
                    'Need more points to play! Buy points to continue.';
                document.getElementById('optionsContainer').innerHTML = '';
            }
        }

        // ==============================================
        // UI UPDATES
        // ==============================================
        function updateUI() {
            updatePointsDisplay();
            updateStats();
            updatePlayButton();
        }

        function updatePointsDisplay() {
            document.getElementById('userPoints').textContent = 
                gameState.points.toLocaleString();
        }

        function updateStats() {
            document.getElementById('gamesPlayed').textContent = gameState.gamesPlayed;
            document.getElementById('gamesWon').textContent = gameState.gamesWon;
            
            const winRate = gameState.gamesPlayed > 0 ? 
                Math.round((gameState.gamesWon / gameState.gamesPlayed) * 100) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
            
            const totalWon = gameState.gamesWon * 500;
            document.getElementById('totalWon').textContent = totalWon.toLocaleString();
        }

        // ==============================================
        // MODAL FUNCTIONS
        // ==============================================
        function showResultModal(type, title, message) {
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultIcon');
            const titleElement = document.getElementById('resultTitle');
            const messageElement = document.getElementById('resultMessage');
            
            if (type === 'success') {
                icon.innerHTML = '<i class="fas fa-trophy" style="color: #FF9F1C;"></i>';
                titleElement.style.color = 'var(--success)';
            } else {
                icon.innerHTML = '<i class="fas fa-times-circle" style="color: var(--danger);"></i>';
                titleElement.style.color = 'var(--danger)';
            }
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function handleKeyboardShortcuts(e) {
            // Number keys 1-4 for answer selection
            if (gameState.isPlaying && e.key >= '1' && e.key <= '4') {
                const index = parseInt(e.key) - 1;
                const options = document.querySelectorAll('.option-btn');
                if (options[index]) {
                    options[index].click();
                }
            }
            
            // Enter key to submit
            if (e.key === 'Enter' && gameState.isPlaying) {
                document.getElementById('submitBtn').click();
            }
            
            // Space bar to play
            if (e.key === ' ' && !gameState.isPlaying && gameState.points >= 100) {
                document.getElementById('playBtn').click();
            }
        }

        // ==============================================
        // CASH OUT FUNCTIONALITY (For later)
        // ==============================================
        function cashOutPoints() {
            if (gameState.points < 500) {
                showResultModal('error', 'Minimum Cash Out', 
                    'You need at least 500 points (KSh 5) to cash out.');
                return;
            }
            
            // In production, implement M-Pesa disbursement
            const cashAmount = Math.floor(gameState.points / 100); // 1 point = 1 KSh
            
            showResultModal('info', 'Cash Out Request', 
                `Request sent to cash out ${gameState.points} points (KSh ${cashAmount}). ` +
                `Funds will be sent to your M-Pesa within 24 hours.`);
            
            // Reset points after cash out
            gameState.points = 0;
            updatePointsDisplay();
            updatePlayButton();
        }

        // Add cash out button to header (optional)
        function addCashOutButton() {
            const pointsContainer = document.querySelector('.points-container');
            const cashOutBtn = document.createElement('button');
            cashOutBtn.className = 'btn btn-primary';
            cashOutBtn.style.marginLeft = '10px';
            cashOutBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Cash Out';
            cashOutBtn.onclick = cashOutPoints;
            pointsContainer.appendChild(cashOutBtn);
        }

        
    </script>
</body>
</html>
